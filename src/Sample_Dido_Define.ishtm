<!DOCTYPE html>
<html>
  <head>
    <title>DN Solutions | DI/DO Define</title>
    <meta charset="<!-- #echo var={_CHARSET} -->" />
    <link rel="stylesheet" type="text/css" href="/frh/ihmi/ihmicomponentstyl.css" />
    <link rel="stylesheet" type="text/css" href="/frh/ihmi/ihmicomponentfrm.css" />
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: #f5f5f5;
        min-height: 100vh;
      }
      .wrap {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px;
      }
      .header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 24px;
        background: white;
        padding: 20px 24px;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      }
      .header h2 {
        margin: 0;
        color: #333;
        font-size: 22px;
        font-weight: 600;
      }
      .spacer {
        flex: 1;
      }

      /* Toggle Switch */
      .toggle-container {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .toggle-label {
        font-weight: 600;
        color: #4a5568;
        font-size: 14px;
      }
      .toggle-switch {
        position: relative;
        width: 56px;
        height: 28px;
        background: #d0d0d0;
        border-radius: 34px;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .toggle-switch.active {
        background: #555;
      }
      .toggle-slider {
        position: absolute;
        top: 2px;
        left: 2px;
        width: 24px;
        height: 24px;
        background: white;
        border-radius: 50%;
        transition: transform 0.3s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }
      .toggle-switch.active .toggle-slider {
        transform: translateX(28px);
      }
      .toggle-status {
        font-weight: 700;
        font-size: 13px;
        min-width: 36px;
      }
      .toggle-status.off {
        color: #999;
      }
      .toggle-status.on {
        color: #555;
      }

      .btn-nav {
        display: inline-block;
        padding: 10px 20px;
        background: #555;
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-weight: 600;
        font-size: 14px;
        transition: background 0.2s;
      }
      .btn-nav:hover {
        background: #333;
      }
      .panel {
        background: white;
        border-radius: 8px;
        padding: 20px;
        border: 1px solid #e0e0e0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      }
      .grid {
        display: grid;
        grid-template-columns: 50px 1fr 120px 80px 100px;
        gap: 12px;
        align-items: center;
        padding: 12px 16px;
        border-radius: 8px;
        transition: background-color 0.2s;
      }
      .grid:hover {
        background: #f7fafc;
      }
      .start-row {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 16px;
        padding: 12px 16px;
        background: #f9f9f9;
        border-radius: 6px;
        border: 1px solid #e0e0e0;
      }
      .start-group {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .start-label {
        font-weight: 600;
        color: #555;
        font-size: 13px;
        white-space: nowrap;
        flex-shrink: 0;
      }
      .start-input {
        flex: 1;
        padding: 8px 12px;
        font-size: 14px;
        min-width: 0;
      }
      .th {
        font-weight: 700;
        background: #666;
        color: white;
        padding: 12px 8px;
        border-radius: 6px;
        text-align: center;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .label {
        font-weight: 700;
        color: #555;
        text-align: center;
        background: #e8e8e8;
        padding: 8px;
        border-radius: 6px;
        font-size: 14px;
      }
      .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
        background: white;
        padding: 8px;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      }
      .tab {
        flex: 1;
        padding: 12px 24px;
        cursor: pointer;
        background: transparent;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        color: #888;
        font-size: 15px;
        transition: all 0.2s;
        text-align: center;
      }
      .tab:hover {
        background: #f5f5f5;
        color: #555;
      }
      .tab.active {
        background: #555;
        color: white;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
        animation: fadeIn 0.3s;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      input[type="text"],
      input[type="number"] {
        padding: 10px 14px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        width: 100%;
        font-family: inherit;
        transition: all 0.2s;
      }
      input:focus {
        outline: none;
        border-color: #666;
        box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
      }
      input:disabled {
        background: #f9f9f9;
        color: #aaa;
        cursor: not-allowed;
        border-color: #e8e8e8;
      }
      .log-panel {
        margin-top: 20px;
        background: white;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      }
      .log-panel.hidden {
        display: none;
      }
      .log-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        border-bottom: 1px solid #e0e0e0;
        background: #f9f9f9;
        border-radius: 8px 8px 0 0;
      }
      .log-title {
        font-weight: 600;
        color: #555;
        font-size: 14px;
      }
      .btn-toggle-log {
        padding: 6px 12px;
        background: #888;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        transition: background 0.2s;
      }
      .btn-toggle-log:hover {
        background: #666;
      }
      .log {
        padding: 16px;
        font-family: "Courier New", monospace;
        font-size: 12px;
        white-space: pre-wrap;
        height: 200px;
        overflow-y: auto;
        color: #333;
        line-height: 1.6;
      }
      .log::-webkit-scrollbar {
        width: 8px;
      }
      .log::-webkit-scrollbar-track {
        background: #f5f5f5;
        border-radius: 4px;
      }
      .log::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 4px;
      }
      .log::-webkit-scrollbar-thumb:hover {
        background: #999;
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="header">
        <h2 style="margin: 0">DI/DO Define</h2>
        <div class="spacer"></div>
        <button class="btn-toggle-log" onclick="toggleLog()">Show Log</button>
        <div class="toggle-container" style="margin-left: 16px;">
          <span class="toggle-label">Edit Mode</span>
          <div class="toggle-switch" id="toggleSwitch" onclick="toggleEdit()">
            <div class="toggle-slider"></div>
          </div>
          <span class="toggle-status off" id="toggleStatus">OFF</span>
        </div>
      </div>

      <div class="tabs">
        <div class="tab active" onclick="switchTab('DI')">Digital Input (DI)</div>
        <div class="tab" onclick="switchTab('DO')">Digital Output (DO)</div>
      </div>

      <!-- DI Tab Content -->
      <div id="tab-DI" class="tab-content active">
        <div class="panel">
          <div class="start-row">
            <div class="start-group">
              <span class="start-label">Start CNC Address:</span>
              <input type="number" id="DI_START" class="start-input" min="0" max="9999" />
            </div>
            <div class="start-group">
              <span class="start-label">Start DI Address:</span>
              <input type="number" id="DI_BASE" class="start-input" min="0" max="99999" />
            </div>
          </div>
          <div class="grid" style="margin-bottom: 6px">
            <div class="th">#</div>
            <div class="th">NAME</div>
            <div class="th">ADDRESS</div>
            <div class="th">BIT</div>
            <div class="th">DI</div>
          </div>
          <div class="grid">
            <div class="label">1</div>
            <input type="text" id="DI_NAME_1" maxlength="32" />
            <input type="number" id="DI_ADDR_1" min="0" max="9999" />
            <input type="number" id="DI_BIT_1" min="0" max="7" />
            <input type="text" id="DI_OFFSET_1" readonly style="background: #f0f0f0; cursor: default" />
          </div>
          <div class="grid">
            <div class="label">2</div>
            <input type="text" id="DI_NAME_2" maxlength="32" />
            <input type="number" id="DI_ADDR_2" min="0" max="9999" />
            <input type="number" id="DI_BIT_2" min="0" max="7" />
            <input type="text" id="DI_OFFSET_2" readonly style="background: #f0f0f0; cursor: default" />
          </div>
          <div class="grid">
            <div class="label">3</div>
            <input type="text" id="DI_NAME_3" maxlength="32" />
            <input type="number" id="DI_ADDR_3" min="0" max="9999" />
            <input type="number" id="DI_BIT_3" min="0" max="7" />
            <input type="text" id="DI_OFFSET_3" readonly style="background: #f0f0f0; cursor: default" />
          </div>
          <div class="grid">
            <div class="label">4</div>
            <input type="text" id="DI_NAME_4" maxlength="32" />
            <input type="number" id="DI_ADDR_4" min="0" max="9999" />
            <input type="number" id="DI_BIT_4" min="0" max="7" />
            <input type="text" id="DI_OFFSET_4" readonly style="background: #f0f0f0; cursor: default" />
          </div>
          <div class="grid">
            <div class="label">5</div>
            <input type="text" id="DI_NAME_5" maxlength="32" />
            <input type="number" id="DI_ADDR_5" min="0" max="9999" />
            <input type="number" id="DI_BIT_5" min="0" max="7" />
            <input type="text" id="DI_OFFSET_5" readonly style="background: #f0f0f0; cursor: default" />
          </div>
          <div class="grid">
            <div class="label">6</div>
            <input type="text" id="DI_NAME_6" maxlength="32" />
            <input type="number" id="DI_ADDR_6" min="0" max="9999" />
            <input type="number" id="DI_BIT_6" min="0" max="7" />
            <input type="text" id="DI_OFFSET_6" readonly style="background: #f0f0f0; cursor: default" />
          </div>
          <div class="grid">
            <div class="label">7</div>
            <input type="text" id="DI_NAME_7" maxlength="32" />
            <input type="number" id="DI_ADDR_7" min="0" max="9999" />
            <input type="number" id="DI_BIT_7" min="0" max="7" />
            <input type="text" id="DI_OFFSET_7" readonly style="background: #f0f0f0; cursor: default" />
          </div>
          <div class="grid">
            <div class="label">8</div>
            <input type="text" id="DI_NAME_8" maxlength="32" />
            <input type="number" id="DI_ADDR_8" min="0" max="9999" />
            <input type="number" id="DI_BIT_8" min="0" max="7" />
            <input type="text" id="DI_OFFSET_8" readonly style="background: #f0f0f0; cursor: default" />
          </div>
          <div class="grid">
            <div class="label">9</div>
            <input type="text" id="DI_NAME_9" maxlength="32" />
            <input type="number" id="DI_ADDR_9" min="0" max="9999" />
            <input type="number" id="DI_BIT_9" min="0" max="7" />
            <input type="text" id="DI_OFFSET_9" readonly style="background: #f0f0f0; cursor: default" />
          </div>
          <div class="grid">
            <div class="label">10</div>
            <input type="text" id="DI_NAME_10" maxlength="32" />
            <input type="number" id="DI_ADDR_10" min="0" max="9999" />
            <input type="number" id="DI_BIT_10" min="0" max="7" />
            <input type="text" id="DI_OFFSET_10" readonly style="background: #f0f0f0; cursor: default" />
          </div>
        </div>
      </div>

      <!-- DO Tab Content -->
      <div id="tab-DO" class="tab-content">
        <div class="panel">
          <div class="start-row">
            <div class="start-group">
              <span class="start-label">Start CNC Address:</span>
              <input type="number" id="DO_START" class="start-input" min="0" max="9999" />
            </div>
            <div class="start-group">
              <span class="start-label">Start DO Address:</span>
              <input type="number" id="DO_BASE" class="start-input" min="0" max="99999" />
            </div>
          </div>
          <div class="grid" style="margin-bottom: 6px">
            <div class="th">#</div>
            <div class="th">NAME</div>
            <div class="th">ADDRESS</div>
            <div class="th">BIT</div>
            <div class="th">DO</div>
          </div>
          <div class="grid">
            <div class="label">1</div>
            <input type="text" id="DO_NAME_1" maxlength="32" />
            <input type="number" id="DO_ADDR_1" min="0" max="9999" />
            <input type="number" id="DO_BIT_1" min="0" max="7" />
            <input type="text" id="DO_OFFSET_1" readonly style="background: #f0f0f0; cursor: default" />
          </div>
          <div class="grid">
            <div class="label">2</div>
            <input type="text" id="DO_NAME_2" maxlength="32" />
            <input type="number" id="DO_ADDR_2" min="0" max="9999" />
            <input type="number" id="DO_BIT_2" min="0" max="7" />
            <input type="text" id="DO_OFFSET_2" readonly style="background: #f0f0f0; cursor: default" />
          </div>
          <div class="grid">
            <div class="label">3</div>
            <input type="text" id="DO_NAME_3" maxlength="32" />
            <input type="number" id="DO_ADDR_3" min="0" max="9999" />
            <input type="number" id="DO_BIT_3" min="0" max="7" />
            <input type="text" id="DO_OFFSET_3" readonly style="background: #f0f0f0; cursor: default" />
          </div>
          <div class="grid">
            <div class="label">4</div>
            <input type="text" id="DO_NAME_4" maxlength="32" />
            <input type="number" id="DO_ADDR_4" min="0" max="9999" />
            <input type="number" id="DO_BIT_4" min="0" max="7" />
            <input type="text" id="DO_OFFSET_4" readonly style="background: #f0f0f0; cursor: default" />
          </div>
          <div class="grid">
            <div class="label">5</div>
            <input type="text" id="DO_NAME_5" maxlength="32" />
            <input type="number" id="DO_ADDR_5" min="0" max="9999" />
            <input type="number" id="DO_BIT_5" min="0" max="7" />
            <input type="text" id="DO_OFFSET_5" readonly style="background: #f0f0f0; cursor: default" />
          </div>
          <div class="grid">
            <div class="label">6</div>
            <input type="text" id="DO_NAME_6" maxlength="32" />
            <input type="number" id="DO_ADDR_6" min="0" max="9999" />
            <input type="number" id="DO_BIT_6" min="0" max="7" />
            <input type="text" id="DO_OFFSET_6" readonly style="background: #f0f0f0; cursor: default" />
          </div>
          <div class="grid">
            <div class="label">7</div>
            <input type="text" id="DO_NAME_7" maxlength="32" />
            <input type="number" id="DO_ADDR_7" min="0" max="9999" />
            <input type="number" id="DO_BIT_7" min="0" max="7" />
            <input type="text" id="DO_OFFSET_7" readonly style="background: #f0f0f0; cursor: default" />
          </div>
          <div class="grid">
            <div class="label">8</div>
            <input type="text" id="DO_NAME_8" maxlength="32" />
            <input type="number" id="DO_ADDR_8" min="0" max="9999" />
            <input type="number" id="DO_BIT_8" min="0" max="7" />
            <input type="text" id="DO_OFFSET_8" readonly style="background: #f0f0f0; cursor: default" />
          </div>
          <div class="grid">
            <div class="label">9</div>
            <input type="text" id="DO_NAME_9" maxlength="32" />
            <input type="number" id="DO_ADDR_9" min="0" max="9999" />
            <input type="number" id="DO_BIT_9" min="0" max="7" />
            <input type="text" id="DO_OFFSET_9" readonly style="background: #f0f0f0; cursor: default" />
          </div>
          <div class="grid">
            <div class="label">10</div>
            <input type="text" id="DO_NAME_10" maxlength="32" />
            <input type="number" id="DO_ADDR_10" min="0" max="9999" />
            <input type="number" id="DO_BIT_10" min="0" max="7" />
            <input type="text" id="DO_OFFSET_10" readonly style="background: #f0f0f0; cursor: default" />
          </div>
        </div>
      </div>

      <div id="logPanel" class="log-panel hidden">
        <div class="log-header">
          <span class="log-title">System Log</span>
          <button class="btn-toggle-log" onclick="toggleLog()">Hide</button>
        </div>
        <div id="log" class="log"></div>
      </div>
    </div>

    <script type="text/javascript">
      const KAREL_PROGRAM_NAME = "IPL_DN_SimTen_Cfg";
      const NAME_MIN = "1",
        NAME_MAX = "32";
      const ADDR_MIN = "0",
        ADDR_MAX = "9999";
      const BIT_MIN = "0",
        BIT_MAX = "7";

      function log(msg) {
        const box = document.getElementById("log");
        const t = new Date(),
          ts = [t.getHours(), t.getMinutes(), t.getSeconds()].map((n) => String(n).padStart(2, "0")).join(":");
        box.textContent += "[" + ts + "] " + msg + "\n";
        box.scrollTop = box.scrollHeight;
      }

      function ihmiGet(kvar, cb) {
        try {
          top.ihmi_getVar(KAREL_PROGRAM_NAME, kvar, cb);
        } catch (e) {
          log("ihmi_getVar error " + kvar + ": " + e);
        }
      }

      function ihmiSet(kvar, val) {
        try {
          top.ihmi_setVar(KAREL_PROGRAM_NAME, kvar, val);
          log("SET " + kvar + " = " + val);
        } catch (e) {
          log("ihmi_setVar error " + kvar + ": " + e);
        }
      }

      function calculateOffset(startAddr, addr, bit) {
        // Calculate offset in bits from START_ADDR.0
        // Example: START=3000, ADDR=3001, BIT=7 => offset = (3001-3000)*8 + 7 = 15
        const startAddrNum = parseInt(startAddr, 10) || 0;
        const addrNum = parseInt(addr, 10) || 0;
        const bitNum = parseInt(bit, 10) || 0;

        const offset = (addrNum - startAddrNum) * 8 + bitNum;
        return offset;
      }

      function updateOffset(prefix, index) {
        // Update offset for DI or DO
        const startEl = document.getElementById(prefix + "_START");
        const baseEl = document.getElementById(prefix + "_BASE");
        const addrEl = document.getElementById(prefix + "_ADDR_" + index);
        const bitEl = document.getElementById(prefix + "_BIT_" + index);
        const offsetEl = document.getElementById(prefix + "_OFFSET_" + index);

        if (!startEl || !baseEl || !addrEl || !bitEl || !offsetEl) return;

        const offset = calculateOffset(startEl.value, addrEl.value, bitEl.value);
        const baseAddress = parseInt(baseEl.value) || 0;

        // Display as "DI[base+offset]" or "DO[base+offset]"
        const displayValue = prefix + "[" + (baseAddress + offset) + "]";
        offsetEl.value = displayValue;

        // Write offset to KAREL
        ihmiSet(prefix + "_OFFSET[" + index + "]", offset);
      }

      function bindVariable(domId, kvar) {
        const el = document.getElementById(domId);
        if (!el) {
          log("Missing element: " + domId);
          return;
        }

        // Read initial value from KAREL
        ihmiGet(kvar, (kprog, kv, type, val) => {
          el.value = val ?? "";
          log("BOUND " + domId + " <=> " + kvar + " | READ=" + val);

          // If this is ADDR or BIT, calculate offset
          const match = domId.match(/(DI|DO)_(ADDR|BIT)_(\d+)/);
          if (match) {
            const prefix = match[1];
            const index = match[3];
            updateOffset(prefix, index);
          }
        });

        // Set up change listener to write back to KAREL
        el.addEventListener("change", function () {
          const newVal = el.value;
          ihmiSet(kvar, newVal);

          // If this is START, ADDR, or BIT, recalculate all offsets
          if (domId.includes("_START")) {
            const prefix = domId.replace("_START", "");
            for (let i = 1; i <= 10; i++) {
              updateOffset(prefix, i);
            }
          } else {
            const match = domId.match(/(DI|DO)_(ADDR|BIT)_(\d+)/);
            if (match) {
              const prefix = match[1];
              const index = match[3];
              updateOffset(prefix, index);
            }
          }
        });
      }

      function switchTab(tabName) {
        // Remove active class from all tabs
        const tabs = document.querySelectorAll(".tab");
        tabs.forEach((tab) => tab.classList.remove("active"));

        // Remove active class from all tab contents
        const tabContents = document.querySelectorAll(".tab-content");
        tabContents.forEach((content) => content.classList.remove("active"));

        // Add active class to selected tab
        event.target.classList.add("active");

        // Show selected tab content
        document.getElementById("tab-" + tabName).classList.add("active");

        log("Switched to " + tabName + " tab");
      }

      function bindAll() {
        // Bind DI START
        bindVariable("DI_START", "DI_START");

        // Bind DI_OFFSET_START with default value
        ihmiGet("DI_OFFSET_START", (_, kv, t, v) => {
          const val = parseInt(v, 10) || 0;
          const diBase = document.getElementById("DI_BASE");
          if (diBase) {
            if (val === 0) {
              // No value, set default to 10000
              diBase.value = 10000;
              ihmiSet("DI_OFFSET_START", 10000);
            } else {
              diBase.value = val;
            }
            // Update all DI offsets
            for (let i = 1; i <= 10; i++) {
              updateOffset("DI", i);
            }
          }
        });

        // Bind DI[1~10]
        for (let i = 1; i <= 10; i++) {
          bindVariable("DI_NAME_" + i, "DI_NAME[" + i + "]");
          bindVariable("DI_ADDR_" + i, "DI_ADDR[" + i + "]");
          bindVariable("DI_BIT_" + i, "DI_BIT[" + i + "]");
          // OFFSET is calculated, not bound
        }

        // Bind DO START
        bindVariable("DO_START", "DO_START");

        // Bind DO_OFFSET_START with default value
        ihmiGet("DO_OFFSET_START", (_, kv, t, v) => {
          const val = parseInt(v, 10) || 0;
          const doBase = document.getElementById("DO_BASE");
          if (doBase) {
            if (val === 0) {
              // No value, set default to 20000
              doBase.value = 20000;
              ihmiSet("DO_OFFSET_START", 20000);
            } else {
              doBase.value = val;
            }
            // Update all DO offsets
            for (let i = 1; i <= 10; i++) {
              updateOffset("DO", i);
            }
          }
        });

        // Bind DO[1~10]
        for (let i = 1; i <= 10; i++) {
          bindVariable("DO_NAME_" + i, "DO_NAME[" + i + "]");
          bindVariable("DO_ADDR_" + i, "DO_ADDR[" + i + "]");
          bindVariable("DO_BIT_" + i, "DO_BIT[" + i + "]");
          // OFFSET is calculated, not bound
        }
      }

      function updateToggleUI(enabled) {
        const toggleSwitch = document.getElementById("toggleSwitch");
        const toggleStatus = document.getElementById("toggleStatus");

        if (enabled) {
          toggleSwitch.classList.add("active");
          toggleStatus.textContent = "ON";
          toggleStatus.className = "toggle-status on";
        } else {
          toggleSwitch.classList.remove("active");
          toggleStatus.textContent = "OFF";
          toggleStatus.className = "toggle-status off";
        }
      }

      function updateInputsState(enabled) {
        // Update DI START and BASE
        const diStart = document.getElementById("DI_START");
        const diBase = document.getElementById("DI_BASE");
        if (diStart) diStart.disabled = !enabled;
        if (diBase) diBase.disabled = !enabled;

        // Update DI input fields based on EDIT_ENABLE state
        for (let i = 1; i <= 10; i++) {
          const nameInput = document.getElementById("DI_NAME_" + i);
          const addrInput = document.getElementById("DI_ADDR_" + i);
          const bitInput = document.getElementById("DI_BIT_" + i);

          if (nameInput) nameInput.disabled = !enabled;
          if (addrInput) addrInput.disabled = !enabled;
          if (bitInput) bitInput.disabled = !enabled;
        }

        // Update DO START and BASE
        const doStart = document.getElementById("DO_START");
        const doBase = document.getElementById("DO_BASE");
        if (doStart) doStart.disabled = !enabled;
        if (doBase) doBase.disabled = !enabled;

        // Update DO input fields based on EDIT_ENABLE state
        for (let i = 1; i <= 10; i++) {
          const nameInput = document.getElementById("DO_NAME_" + i);
          const addrInput = document.getElementById("DO_ADDR_" + i);
          const bitInput = document.getElementById("DO_BIT_" + i);

          if (nameInput) nameInput.disabled = !enabled;
          if (addrInput) addrInput.disabled = !enabled;
          if (bitInput) bitInput.disabled = !enabled;
        }

        // Update toggle UI
        updateToggleUI(enabled);
      }

      function readEdit() {
        ihmiGet("EDIT_ENABLE", (_, kv, t, v) => {
          const n = parseInt(v, 10) || 0;
          document.getElementById("editVal").innerText = n;
          updateInputsState(n === 1);
          log("READ EDIT_ENABLE = " + n);
        });
      }

      function toggleEdit() {
        ihmiGet("EDIT_ENABLE", (_, kv, t, v) => {
          const cur = parseInt(v, 10) || 0;
          const next = cur ? 0 : 1;
          ihmiSet("EDIT_ENABLE", next);
          updateInputsState(next === 1);
          log("Edit Mode: " + (next === 1 ? "ENABLED" : "DISABLED"));
        });
      }

      function toggleLog() {
        const logPanel = document.getElementById("logPanel");
        const buttons = document.querySelectorAll(".btn-toggle-log");

        if (logPanel.classList.contains("hidden")) {
          logPanel.classList.remove("hidden");
          buttons.forEach(btn => btn.textContent = btn.textContent.includes("Show") ? "Hide Log" : "Hide");
        } else {
          logPanel.classList.add("hidden");
          buttons.forEach(btn => btn.textContent = btn.textContent.includes("Hide") ? "Show Log" : "Show");
        }
      }

      window.onload = () => {
        log("System Loaded. Auto-bind DI[1~10] and DO[1~10].");
        readEdit();
        bindAll();

        // Add change event listeners for BASE addresses
        const diBase = document.getElementById("DI_BASE");
        const doBase = document.getElementById("DO_BASE");

        if (diBase) {
          diBase.addEventListener("change", () => {
            const val = parseInt(diBase.value, 10) || 10000;
            ihmiSet("DI_OFFSET_START", val);
            for (let i = 1; i <= 10; i++) {
              updateOffset("DI", i);
            }
          });
        }

        if (doBase) {
          doBase.addEventListener("change", () => {
            const val = parseInt(doBase.value, 10) || 20000;
            ihmiSet("DO_OFFSET_START", val);
            for (let i = 1; i <= 10; i++) {
              updateOffset("DO", i);
            }
          });
        }
      };
    </script>
  </body>
</html>
