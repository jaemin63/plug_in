<!DOCTYPE html>
<html>
  <head>
    <title>DN Solutions | DI[1~10] Config (Auto-Bind)</title>
    <meta charset="<!-- #echo var={_CHARSET} -->" />
    <link rel="stylesheet" type="text/css" href="/frh/ihmi/ihmicomponentstyl.css" />
    <link rel="stylesheet" type="text/css" href="/frh/ihmi/ihmicomponentfrm.css" />
    <style>
      body {
        font-family: sans-serif;
      }
      .wrap {
        margin: 24px;
      }
      .header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
      }
      .spacer {
        flex: 1;
      }
      .badge {
        padding: 6px 10px;
        border-radius: 999px;
        background: #eee;
        font-weight: 700;
      }
      .btn {
        padding: 8px 14px;
        border: 1px solid #ccc;
        border-radius: 8px;
        cursor: pointer;
      }
      .btn-nav {
        display: inline-block;
        padding: 8px 14px;
        background: #007bff;
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 500;
      }
      .btn-nav:hover {
        background: #0056b3;
      }
      .panel {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 12px;
      }
      .grid {
        display: grid;
        grid-template-columns: 60px 240px 140px 80px;
        gap: 8px;
      }
      .th {
        font-weight: 700;
        color: #333;
        background: #fafafa;
        padding: 6px 8px;
        border-radius: 6px;
        text-align: center;
      }
      .log {
        margin-top: 10px;
        padding: 10px;
        border: 1px solid #bbb;
        background: #f6f6f6;
        border-radius: 6px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
        font-size: 13px;
        white-space: pre-wrap;
        height: 220px;
        overflow-y: auto;
      }
      .row2 {
        display: grid;
        grid-template-columns: 160px 1fr;
        gap: 8px;
        align-items: center;
      }
      .label {
        font-weight: 700;
        color: #333;
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="header">
        <h2 style="margin: 0">Config: DI[1~10]</h2>
        <div class="spacer"></div>
        <a href="Sample_Monitor.stm" class="btn-nav">Go to Monitor</a>
        <span class="badge">EDIT_ENABLE: <span id="editVal">?</span></span>
        <ihmi type="button" id="btnToggle" class="btn" width="120px" height="40px">Toggle</ihmi>
      </div>

      <div class="panel">
        <div class="grid" style="margin-bottom: 6px">
          <div class="th">#</div>
          <div class="th">NAME</div>
          <div class="th">ADDRESS</div>
          <div class="th">BIT</div>
        </div>
        <div class="grid">
          <div class="label" style="text-align: center">1</div>
          <ihmi type="textboxString" id="DI_NAME_1" mode="allallowed" designpattern="touch" width="100%" errPopPos="1" unSelect="true"></ihmi>
          <ihmi type="textboxInteger" id="DI_ADDR_1" designpattern="touch" inputType="number" width="100%" errPopPos="1" unSelect="true"></ihmi>
          <ihmi type="textboxInteger" id="DI_BIT_1" designpattern="touch" inputType="number" width="100%" errPopPos="1" unSelect="true"></ihmi>
        </div>
        <div class="grid">
          <div class="label" style="text-align: center">2</div>
          <ihmi type="textboxString" id="DI_NAME_2" mode="allallowed" designpattern="touch" width="100%" errPopPos="1" unSelect="true"></ihmi>
          <ihmi type="textboxInteger" id="DI_ADDR_2" designpattern="touch" inputType="number" width="100%" errPopPos="1" unSelect="true"></ihmi>
          <ihmi type="textboxInteger" id="DI_BIT_2" designpattern="touch" inputType="number" width="100%" errPopPos="1" unSelect="true"></ihmi>
        </div>
        <div class="grid">
          <div class="label" style="text-align: center">3</div>
          <ihmi type="textboxString" id="DI_NAME_3" mode="allallowed" designpattern="touch" width="100%" errPopPos="1" unSelect="true"></ihmi>
          <ihmi type="textboxInteger" id="DI_ADDR_3" designpattern="touch" inputType="number" width="100%" errPopPos="1" unSelect="true"></ihmi>
          <ihmi type="textboxInteger" id="DI_BIT_3" designpattern="touch" inputType="number" width="100%" errPopPos="1" unSelect="true"></ihmi>
        </div>
        <div class="grid">
          <div class="label" style="text-align: center">4</div>
          <ihmi type="textboxString" id="DI_NAME_4" mode="allallowed" designpattern="touch" width="100%" errPopPos="1" unSelect="true"></ihmi>
          <ihmi type="textboxInteger" id="DI_ADDR_4" designpattern="touch" inputType="number" width="100%" errPopPos="1" unSelect="true"></ihmi>
          <ihmi type="textboxInteger" id="DI_BIT_4" designpattern="touch" inputType="number" width="100%" errPopPos="1" unSelect="true"></ihmi>
        </div>
        <div class="grid">
          <div class="label" style="text-align: center">5</div>
          <ihmi type="textboxString" id="DI_NAME_5" mode="allallowed" designpattern="touch" width="100%" errPopPos="1" unSelect="true"></ihmi>
          <ihmi type="textboxInteger" id="DI_ADDR_5" designpattern="touch" inputType="number" width="100%" errPopPos="1" unSelect="true"></ihmi>
          <ihmi type="textboxInteger" id="DI_BIT_5" designpattern="touch" inputType="number" width="100%" errPopPos="1" unSelect="true"></ihmi>
        </div>
        <div class="grid">
          <div class="label" style="text-align: center">6</div>
          <ihmi type="textboxString" id="DI_NAME_6" mode="allallowed" designpattern="touch" width="100%" errPopPos="1" unSelect="true"></ihmi>
          <ihmi type="textboxInteger" id="DI_ADDR_6" designpattern="touch" inputType="number" width="100%" errPopPos="1" unSelect="true"></ihmi>
          <ihmi type="textboxInteger" id="DI_BIT_6" designpattern="touch" inputType="number" width="100%" errPopPos="1" unSelect="true"></ihmi>
        </div>
        <div class="grid">
          <div class="label" style="text-align: center">7</div>
          <ihmi type="textboxString" id="DI_NAME_7" mode="allallowed" designpattern="touch" width="100%" errPopPos="1" unSelect="true"></ihmi>
          <ihmi type="textboxInteger" id="DI_ADDR_7" designpattern="touch" inputType="number" width="100%" errPopPos="1" unSelect="true"></ihmi>
          <ihmi type="textboxInteger" id="DI_BIT_7" designpattern="touch" inputType="number" width="100%" errPopPos="1" unSelect="true"></ihmi>
        </div>
        <div class="grid">
          <div class="label" style="text-align: center">8</div>
          <ihmi type="textboxString" id="DI_NAME_8" mode="allallowed" designpattern="touch" width="100%" errPopPos="1" unSelect="true"></ihmi>
          <ihmi type="textboxInteger" id="DI_ADDR_8" designpattern="touch" inputType="number" width="100%" errPopPos="1" unSelect="true"></ihmi>
          <ihmi type="textboxInteger" id="DI_BIT_8" designpattern="touch" inputType="number" width="100%" errPopPos="1" unSelect="true"></ihmi>
        </div>
        <div class="grid">
          <div class="label" style="text-align: center">9</div>
          <ihmi type="textboxString" id="DI_NAME_9" mode="allallowed" designpattern="touch" width="100%" errPopPos="1" unSelect="true"></ihmi>
          <ihmi type="textboxInteger" id="DI_ADDR_9" designpattern="touch" inputType="number" width="100%" errPopPos="1" unSelect="true"></ihmi>
          <ihmi type="textboxInteger" id="DI_BIT_9" designpattern="touch" inputType="number" width="100%" errPopPos="1" unSelect="true"></ihmi>
        </div>
        <div class="grid">
          <div class="label" style="text-align: center">10</div>
          <ihmi type="textboxString" id="DI_NAME_10" mode="allallowed" designpattern="touch" width="100%" errPopPos="1" unSelect="true"></ihmi>
          <ihmi type="textboxInteger" id="DI_ADDR_10" designpattern="touch" inputType="number" width="100%" errPopPos="1" unSelect="true"></ihmi>
          <ihmi type="textboxInteger" id="DI_BIT_10" designpattern="touch" inputType="number" width="100%" errPopPos="1" unSelect="true"></ihmi>
        </div>
      </div>

      <div id="log" class="log"></div>
    </div>

    <script type="text/javascript">
      const KAREL_PROGRAM_NAME = "IPL_DN_SmplGrp_Cfg";
      // For textboxString: iHMI interprets these as min/max length
      const NAME_MIN = "1",
        NAME_MAX = "32";
      const ADDR_MIN = "0",
        ADDR_MAX = "9999";
      const BIT_MIN = "0",
        BIT_MAX = "7";

      function log(msg) {
        const box = document.getElementById("log");
        const t = new Date(),
          ts = [t.getHours(), t.getMinutes(), t.getSeconds()].map((n) => String(n).padStart(2, "0")).join(":");
        box.textContent += "[" + ts + "] " + msg + "\n";
        box.scrollTop = box.scrollHeight;
      }

      function ihmiGet(kvar, cb) {
        try {
          top.ihmi_getVar(KAREL_PROGRAM_NAME, kvar, cb);
        } catch (e) {
          log("ihmi_getVar error " + kvar + ": " + e);
        }
      }
      function ihmiSet(kvar, val) {
        try {
          top.ihmi_setVar(KAREL_PROGRAM_NAME, kvar, val);
          log("SET " + kvar + " = " + val);
        } catch (e) {
          log("ihmi_setVar error " + kvar + ": " + e);
        }
      }

      // Generic binder with readiness wait
      function registerVarWait(domId, kvar, minStr, maxStr, retries) {
        retries = retries == null ? 80 : retries; // up to ~8s
        const el = document.getElementById(domId);
        if (!el) {
          log("Missing element: " + domId);
          return;
        }

        if (typeof el.refresh !== "function" || typeof el.setCallback !== "function") {
          if (retries <= 0) {
            log("Timeout: iHMI API not ready for " + domId);
            return;
          }
          return setTimeout(() => registerVarWait(domId, kvar, minStr, maxStr, retries - 1), 100);
        }

        ihmiGet(kvar, (kprog, kv, type, val) => {
          try {
            if (minStr == null && maxStr != null) {
              // textboxString: refresh(val, maxStr, false) - 3 args only
              el.refresh(val ?? "", String(maxStr), false);
            } else if (minStr != null && maxStr != null) {
              el.refresh(val ?? "", String(minStr), String(maxStr), false);
            } else {
              el.refresh(val ?? "", null, null, false);
            }
            if (typeof el.enable === "function") el.enable(); // ensure editable
          } catch (e) {
            log("refresh failed(" + domId + "): " + e);
            return;
          }

          try {
            el.setCallback((element_id, t, new_value) => {
              const baseId = element_id.split(".")[0]; // strip .textbox/.value
              if (baseId !== domId) return;
              ihmiSet(kvar, new_value);
            });
          } catch (e) {
            log("setCallback failed(" + domId + "): " + e);
            return;
          }

          log("BOUND " + domId + " â†” " + kvar + " | READ=" + val);
        });
      }

      function bindAll() {
        // Bind DI[1~10]
        for (let i = 1; i <= 10; i++) {
          registerVarWait("DI_NAME_" + i, "DI_NAME[" + i + "]", null, NAME_MAX);
          registerVarWait("DI_ADDR_" + i, "DI_ADDR[" + i + "]", ADDR_MIN, ADDR_MAX);
          registerVarWait("DI_BIT_" + i, "DI_BIT[" + i + "]", BIT_MIN, BIT_MAX);
        }
      }

      function readEdit() {
        ihmiGet("EDIT_ENABLE", (_, kv, t, v) => {
          const n = parseInt(v, 10) || 0;
          document.getElementById("editVal").innerText = n;
          log("READ EDIT_ENABLE = " + n);
        });
      }

      window.onload = () => {
        log("Loaded. Auto-bind DI[1~10].");
        readEdit();
        bindAll();

        // Toggle button (write-only)
        const btn = document.getElementById("btnToggle");
        const waitBtn = setInterval(() => {
          if (typeof btn?.setCallback === "function") {
            clearInterval(waitBtn);
            btn.setCallback(() => {
              const cur = parseInt(document.getElementById("editVal").innerText) || 0;
              const next = cur ? 0 : 1;
              ihmiSet("EDIT_ENABLE", next);
              document.getElementById("editVal").innerText = next;
            });
          }
        }, 100);
      };
    </script>
  </body>
</html>
