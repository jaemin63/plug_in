<!DOCTYPE html>
<html>
  <head>
    <title>DN Solutions | Condition Builder</title>
    <meta charset="<!-- #echo var={_CHARSET} -->" />
    <link rel="stylesheet" type="text/css" href="/frh/ihmi/ihmicomponentstyl.css" />
    <link rel="stylesheet" type="text/css" href="/frh/ihmi/ihmicomponentfrm.css" />
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: #f5f5f5;
        min-height: 100vh;
      }
      .wrap {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px;
      }
      .header {
        background: white;
        padding: 20px 24px;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        margin-bottom: 24px;
      }
      .header h2 {
        margin: 0;
        color: #333;
        font-size: 22px;
        font-weight: 600;
      }
      .panel {
        background: white;
        border-radius: 8px;
        padding: 24px;
        border: 1px solid #e0e0e0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        margin-bottom: 20px;
      }
      .section-title {
        font-weight: 700;
        color: #555;
        font-size: 16px;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 2px solid #e0e0e0;
      }

      /* Condition Display Zone */
      .condition-zone {
        min-height: 80px;
        padding: 16px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        background: #fafafa;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }
      .condition-zone.empty::before {
        content: "Select a condition from the list below";
        color: #aaa;
        font-style: italic;
      }

      /* Condition Items (Display Only) */
      .condition-item {
        padding: 8px 14px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-weight: 500;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        user-select: none;
      }
      .condition-item.signal-di {
        border-color: #4a90e2;
        color: #4a90e2;
        background: #e8f4ff;
      }
      .condition-item.signal-do {
        border-color: #e27d4a;
        color: #e27d4a;
        background: #fff4e8;
      }
      .condition-item.operator {
        border-color: #7b68ee;
        color: #7b68ee;
        background: #f0edff;
      }

      /* Select Box */
      .condition-select {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        background: white;
        color: #333;
        cursor: pointer;
        transition: border-color 0.2s;
        margin-bottom: 12px;
      }
      .condition-select:hover {
        border-color: #4a90e2;
      }
      .condition-select:focus {
        outline: none;
        border-color: #4a90e2;
        box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
      }

      /* Checkbox */
      .checkbox-wrapper {
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .checkbox-wrapper input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
      }
      .checkbox-wrapper label {
        font-size: 14px;
        font-weight: 500;
        color: #555;
        cursor: pointer;
      }

      /* Helper Text */
      .helper-text {
        font-size: 12px;
        color: #888;
        margin-top: 8px;
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="header">
        <h2>CNC Signal Read</h2>
      </div>

      <div class="panel">
        <div class="section-title">
          Condition Expression
          <span style="float: right">
            <span class="checkbox-wrapper">
              <input type="checkbox" id="chkWait" onchange="updateParameter()" />
              <label for="chkWait">Wait</label>
            </span>
          </span>
        </div>
        <div id="conditionZone" class="condition-zone empty"></div>
        <div class="helper-text">Selected condition will be displayed here</div>
      </div>

      <div class="panel">
        <div class="section-title">Select Condition</div>
        <select id="conditionSelect" class="condition-select" onchange="onConditionChange()">
          <option value="">-- Select a predefined condition --</option>
        </select>
        <div class="helper-text">Choose from predefined conditions created in Condition Manager</div>
      </div>
    </div>

    <script>
      // ========================================
      // Karel 프로그램 설정
      // ========================================
      var KAREL_PROGRAM_NAME = "IPL_DN_SmplGrp_Cfg";
      var conditions = [];
      var conditionItems = [];

      // ========================================
      // ihmi init 함수 (필수)
      // ========================================
      function init() {
        // ihmi 초기화 - 필수 함수
      }

      // ========================================
      // ihmi_getVar 헬퍼 함수
      // ========================================
      function ihmiGet(kvar, cb) {
        try {
          top.ihmi_getVar(KAREL_PROGRAM_NAME, kvar, cb);
        } catch (e) {
          console.error("ihmi_getVar error " + kvar + ": " + e);
        }
      }

      // ========================================
      // Condition Zone 업데이트 (Display Only)
      // ========================================
      function updateConditionZone() {
        var zone = document.getElementById("conditionZone");
        zone.innerHTML = "";

        if (conditionItems.length === 0) {
          zone.classList.add("empty");
        } else {
          zone.classList.remove("empty");

          conditionItems.forEach(function(item) {
            var div = document.createElement("div");
            div.className = "condition-item " + item.type;
            div.textContent = item.text;
            zone.appendChild(div);
          });
        }
      }

      // ========================================
      // 조건 선택 변경
      // ========================================
      function onConditionChange() {
        var select = document.getElementById("conditionSelect");
        var selectedIndex = select.value;

        if (selectedIndex === "") {
          conditionItems = [];
          updateConditionZone();
        } else {
          var index = parseInt(selectedIndex);
          var expr = conditions[index].expr;
          parseConditionString(expr);
        }

        updateParameter();
      }

      // ========================================
      // 파라미터 업데이트
      // ========================================
      function updateParameter() {
        var conditionStr = conditionItems.map(function(item) {
          return item.text;
        }).join(" ");

        var waitVal = document.getElementById("chkWait").checked ? "1" : "0";
        var paramStr = "'" + conditionStr + "'," + waitVal;

        try {
          parent.setInstructionParam(paramStr);
        } catch (e) {
          // parent가 없는 경우 (테스트 환경)
          console.log("Parameter: " + paramStr);
        }
      }

      // ========================================
      // 드롭 시 초기화 (새 명령어 추가 시)
      // ========================================
      function dropAdvInstData(argStr) {
        if (argStr.length === 0) {
          return false;
        }

        conditionItems = [];
        updateConditionZone();
        document.getElementById("conditionSelect").value = "";
        document.getElementById("chkWait").checked = false;

        var paramStr = "'',0";
        parent.setInstructionParam(paramStr);

        return true;
      }

      // ========================================
      // 표시 (기존 명령어 편집 시)
      // ========================================
      function dispAdvInstData(argStr) {
        if (argStr.length === 0) {
          return false;
        }

        // 파라미터 파싱: "'Condition',Wait"
        var params = argStr.split(",");
        var conditionVal = params[0] ? params[0].replace(/'/g, "") : "";
        var waitVal = params[1] ? params[1] : "0";

        // Wait 체크박스 설정
        document.getElementById("chkWait").checked = waitVal === "1";

        // Condition 파싱 및 복원
        if (conditionVal) {
          parseConditionString(conditionVal);

          // Select box에서 일치하는 조건 찾기
          var select = document.getElementById("conditionSelect");
          var foundIndex = -1;

          for (var i = 0; i < conditions.length; i++) {
            if (conditions[i].expr === conditionVal) {
              foundIndex = i;
              break;
            }
          }

          if (foundIndex !== -1) {
            select.value = String(foundIndex);
          } else {
            select.value = "";
          }
        }

        return true;
      }

      // ========================================
      // Condition 문자열 파싱
      // ========================================
      function parseConditionString(str) {
        conditionItems = [];

        if (!str) {
          updateConditionZone();
          return;
        }

        // 공백 기준으로 분리
        var tokens = str.split(" ");

        tokens.forEach(function(token) {
          token = token.trim();
          if (token === "") return;

          var type = "signal-di"; // 기본값

          if (token === "(" || token === ")" || token === "AND" || token === "OR") {
            type = "operator";
          } else {
            // DI/DO 신호 구분 (DO_NAME으로 시작하면 signal-do)
            if (token.indexOf("DO") === 0) {
              type = "signal-do";
            } else {
              type = "signal-di";
            }
          }

          conditionItems.push({
            text: token,
            type: type
          });
        });

        updateConditionZone();
      }

      // ========================================
      // 조건 목록 로드
      // ========================================
      function loadConditions() {
        var select = document.getElementById("conditionSelect");
        var loadedCount = 0;
        conditions = [];

        for (var i = 0; i < 10; i++) {
          (function(index) {
            ihmiGet("COND_NAME[" + (index + 1) + "]", function(kprog, kv, type, name) {
              ihmiGet("COND_EXPR[" + (index + 1) + "]", function(kprog2, kv2, type2, expr) {
                if (name && name.trim() !== "") {
                  conditions.push({
                    index: index,
                    name: name,
                    expr: expr || ""
                  });
                }

                loadedCount++;

                if (loadedCount === 10) {
                  // 모든 조건 로드 완료 - 인덱스 순서로 정렬
                  conditions.sort(function(a, b) {
                    return a.index - b.index;
                  });

                  // Select box 채우기
                  conditions.forEach(function(cond, idx) {
                    var option = document.createElement("option");
                    option.value = String(idx);
                    option.textContent = cond.name;
                    select.appendChild(option);
                  });
                }
              });
            });
          })(i);
        }
      }

      // ========================================
      // 초기화 (페이지 로드 시)
      // ========================================
      window.onload = function() {
        loadConditions();
      };
    </script>
  </body>
</html>
